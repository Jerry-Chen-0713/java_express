<!DOCTYPE html>
<html style="height: 100%">
   <head>
       <meta charset="utf-8">
       <title>上海市快递区域分布图</title>
       <style>
           body {
               margin: 0;
               padding: 0;
               font-family: Arial, sans-serif;
           }
           .loading {
               text-align: center;
               padding: 50px;
               color: #666;
           }
       </style>
   </head>
   <body style="height: 100%; margin: 0; padding: 0">
       <div id="container" style="height: 100%; width: 100%"></div>
       <div id="loading" class="loading">正在加载数据...</div>
       
       <!-- 使用本地echarts库 -->
       <script type="text/javascript" src="../assets/echarts.min.js"></script>
       <script type="text/javascript" src="../../qrcode/jquery2.1.4.js"></script>
       
       <script type="text/javascript">
           var dom = document.getElementById("container");
           var myChart = echarts.init(dom);
           
           // 从后端获取快递区域分布数据
           function loadExpressData() {
               $.post(
                   "/express/getRegionStats.do",
                   null,
                   function(data){
                       document.getElementById('loading').style.display = 'none';
                       if(data.status == 0 && data.data && data.data.length > 0){
                           renderChart(data.data);
                       } else {
                           // 如果没有数据，显示默认数据
                           renderChart(getDefaultData());
                       }
                   },"JSON"
               ).fail(function() {
                   document.getElementById('loading').style.display = 'none';
                   // 如果请求失败，显示默认数据
                   renderChart(getDefaultData());
               });
           }

           // 默认数据（用于演示）
           function getDefaultData() {
               return [
                   {name: '黄浦区', value: 25},
                   {name: '徐汇区', value: 18},
                   {name: '长宁区', value: 12},
                   {name: '静安区', value: 15},
                   {name: '普陀区', value: 20},
                   {name: '虹口区', value: 16},
                   {name: '杨浦区', value: 22},
                   {name: '闵行区', value: 30},
                   {name: '宝山区', value: 28},
                   {name: '嘉定区', value: 24},
                   {name: '浦东新区', value: 45},
                   {name: '金山区', value: 8},
                   {name: '松江区', value: 18},
                   {name: '青浦区', value: 14},
                   {name: '奉贤区', value: 10},
                   {name: '崇明区', value: 6}
               ];
           }

           // 渲染图表（使用饼图，性能最好）
           function renderChart(data) {
               // 确保包含所有上海市的区
               var allDistricts = [
                   '黄浦区', '徐汇区', '长宁区', '静安区', '普陀区', '虹口区', '杨浦区',
                   '闵行区', '宝山区', '嘉定区', '浦东新区', '金山区', '松江区', 
                   '青浦区', '奉贤区', '崇明区'
               ];
               
               // 创建完整的数据集，确保所有区都有数据
               var completeData = [];
               allDistricts.forEach(function(district) {
                   var found = data.find(function(item) { return item.name === district; });
                   if (found) {
                       completeData.push(found);
                   } else {
                       completeData.push({name: district, value: 0});
                   }
               });
               
               // 按快递数量排序
               completeData.sort(function(a, b) {
                   return b.value - a.value;
               });
               
               var option = {
                   title: {
                       text: '上海市快递区域分布',
                       subtext: '实时快件分布数据',
                       left: 'center'
                   },
                   tooltip: {
                       trigger: 'item',
                       formatter: '{a} <br/>{b}: {c} ({d}%)'
                   },
                   legend: {
                       orient: 'vertical',
                       left: 'left',
                       top: 'middle',
                       type: 'scroll',
                       height: '80%'
                   },
                   series: [
                       {
                           name: '快递数量',
                           type: 'pie',
                           radius: ['30%', '60%'],
                           center: ['60%', '50%'],
                           avoidLabelOverlap: false,
                           itemStyle: {
                               borderRadius: 8,
                               borderColor: '#fff',
                               borderWidth: 2
                           },
                           label: {
                               show: false,
                               position: 'center'
                           },
                           emphasis: {
                               label: {
                                   show: true,
                                   fontSize: '16',
                                   fontWeight: 'bold'
                               }
                           },
                           labelLine: {
                               show: false
                           },
                           data: completeData
                       }
                   ]
               };

               myChart.setOption(option);
           }

           // 页面加载完成后初始化图表
           $(function(){
               loadExpressData();
               
               // 窗口大小变化时重新调整图表大小
               window.addEventListener('resize', function() {
                   myChart.resize();
               });
           });
       </script>
   </body>
</html>
